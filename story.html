<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å°æ€ªç¸æŒ‘æˆ°ç‹çš„æ•…äº‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Story å°ˆç”¨æ¨£å¼ -->
  <style>
    .page-story {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    .story-header h1 {
      text-align: center;
      margin-bottom: 8px;
    }

    .story-header p {
      text-align: center;
      color: #666;
      margin-bottom: 24px;
    }

    .story-animation {
      margin: 16px 0 24px;
      text-align: center;
    }

    .story-content {
      line-height: 1.7;
      font-size: 15px;
      color: #433232;
      margin-bottom: 32px;
    }

    /* ğŸŸ¡ å°æœå‰èªªæ•…äº‹å€å¡Š */
    .story-audio {
      text-align: center;
      margin: 24px auto 40px;
    }

    .story-audio h2 {
      margin-bottom: 8px;
    }

    .story-audio p {
      font-size: 13px;
      color: #777;
      margin-bottom: 12px;
    }

    .story-audio-trigger {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 18px;
      border-radius: 18px;
      background: #fff7da;
      border: 2px solid #ffc96a;
      cursor: pointer;
      box-shadow: 0 4px 0 #e0a84f;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
      user-select: none;
    }

    .story-audio-trigger:hover {
      background: #ffefc0;
    }

    .story-audio-trigger:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #e0a84f;
    }

    .story-audio-trigger.playing {
      background: #ffe8b2;
      box-shadow: 0 2px 0 #d09240;
    }

    .story-voice-avatar {
      width: 96px;
      height: 96px;
      object-fit: contain;
    }

    .story-voice-text {
      font-size: 16px;
      font-weight: bold;
      color: #c0683c;
    }

    .story-audio-hint {
      margin-top: 8px;
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <!-- å…±ç”¨ header -->
  <div class="navbar">
    <a href="index.html" class="nav-btn">é¦–é </a>
    <a href="dashboard.html" class="nav-btn">ä»Šæ—¥ä»»å‹™</a>
    <a href="setting.html" class="nav-btn">ä»»å‹™è¨­å®š</a>
    <a href="rewards.html" class="nav-btn">çå‹µå•†åŸ</a>
    <a href="monsters.html" class="nav-btn">å°æ€ªç¸æ£®æ—</a>
    <a href="story.html" class="nav-btn active">æŒ‘æˆ°ç‹æ•…äº‹</a>    
  </div>

  <main class="page page-story">
    <section class="story-header">
      <h1>å°æ€ªç¸æŒ‘æˆ°ç‹çš„æ•…äº‹</h1>
      <p>åœ¨ä¸€åº§è¢«å¤§æ¨¹åŒ…åœçš„æ£®æ—è£¡ï¼Œä½è‘—ä¸€ç¾¤è¢«æ–½é­”æ³•çš„å°æ€ªç¸â€¦â€¦</p>
    </section>

    <!-- å‹•ç•«å±•ç¤ºå€ï¼ˆä¹‹å¾Œå¯æ› CSS / Lottieï¼‰ -->
    <section class="story-animation">
      <div id="storyAnimationPlaceholder">
      </div>
    </section>

    <!-- æ•…äº‹æ­£æ–‡ï¼ˆæœƒè¢«æŠ“ä¾†å”¸å‡ºä¾†ï¼‰ -->
    <section class="story-content" id="storyContent">
      <h2>æ²‰ç¡çš„å°æ€ªç¸æ£®æ—</h2>
      <p>
        æˆ‘æ˜¯å°æœå‰ï¼Œæˆ‘æ˜¯å‹•åŠ›æ£®æ—çš„å®ˆè­·è€…ï¼Œæœ‰ä¸€å¤©ï¼Œä¸çŸ¥åçš„é­”æ³•é™è‡¨äº†ï¼Œè®“æ‰€æœ‰çš„å°æ€ªç¸éƒ½ç¡è‘—äº†ã€‚  </p>
        <p> 
            ç¥ç§˜è²éŸ³å‘Šè¨´æˆ‘ï¼Œå°æ€ªç¸å€‘åœ¨ç­‰å¾…ä¸€ç¨®å«åšã€Œè‡ªä¸»åŠ›ã€çš„é­”æ³•ä¾†å–šé†’ä»–å€‘ã€‚
      </p>
      <p>
        æ–¼æ˜¯ï¼Œæˆ‘æƒ³é‚€è«‹ä¸–ç•Œä¸Šçš„å°æœ‹å‹ï¼Œä¸€èµ·é€éæ¯å¤©çš„å°ä»»å‹™ï¼Œ
        æŠŠæ£®æ—é»äº®ã€æŠŠå°æ€ªç¸ä¸€éš»ä¸€éš»å–šé†’ï¼Œæ‹œè¨—å¤§å®¶äº†!
      </p>
      <!-- ä¹‹å¾Œå¯ä»¥ç¹¼çºŒè£œç« ç¯€ -->
    </section>

    <!-- ğŸŸ¡ èªéŸ³æ’­æ”¾å€ï¼šæ”¹æˆå°æœå‰åœ–ç¤ºï¼‹é»æˆ‘èªªæ•…äº‹ -->
    <section class="story-audio">
      <h2>ç”¨è½çš„æ•…äº‹æ™‚é–“</h2>
      <p>é»ä¸€ä¸‹å°æœå‰ï¼Œè®“ä»–æŠŠé€™å€‹æ•…äº‹èªªçµ¦å­©å­è½ã€‚</p>

      <!-- é€™å€‹å€å¡Šç•¶æˆæŒ‰éˆ• -->
      <div class="story-audio-trigger" id="storyPlayBtn">
        <!-- é€™è£¡æ›æˆä½ çš„å°æœå‰åœ–ç‰‡è·¯å¾‘ -->
        <img
          src="assets/xiaoguoji_story.png"
          alt="å°æœå‰èªªæ•…äº‹"
          class="story-voice-avatar"
        />
        <div class="story-voice-text">é»æˆ‘èªªæ•…äº‹</div>
      </div>

      <!-- èƒŒæ™¯éŸ³æ¨‚ï¼ˆéš±è—æ§åˆ¶ï¼Œé  JS æ§åˆ¶æ’­æ”¾ï¼‰ -->
      <audio id="bgmAudio" src="assets/audio/story_bgm.mp3" loop></audio>

      <p class="story-audio-hint">
        å°æé†’ï¼šç¬¬ä¸€æ¬¡æ’­æ”¾æ™‚ï¼Œç€è¦½å™¨å¯èƒ½æœƒè«‹ä½ å…è¨±è²éŸ³ï¼Œå»ºè­°æŠŠéŸ³é‡èª¿åˆ°å­©å­è½èµ·ä¾†èˆ’æœçš„å¤§å°ã€‚
      </p>
    </section>
  </main>

  <!-- ğŸ§  èªéŸ³æœ—è®€ + èƒŒæ™¯éŸ³æ¨‚ JS -->
  <script>
    const playBtn = document.getElementById("storyPlayBtn");
    const bgmAudio = document.getElementById("bgmAudio");
    const storyContentEl = document.getElementById("storyContent");
  
    let isPlayingStory = false;
    let currentUtterance = null;
    let storyStartTimer = null;     // â¬…ï¸ è¨˜éŒ„ã€Œ3 ç§’å¾Œé–‹å§‹èªªæ•…äº‹ã€çš„è¨ˆæ™‚å™¨
    let bgmFadeInterval = null;     // â¬…ï¸ è¨˜éŒ„ BGM æ·¡å‡ºç”¨çš„ interval
  
    // å–å¾—æ•…äº‹æ–‡å­—ï¼ˆåªå–æ–‡å­—ï¼Œä¸è¦ HTML æ¨™ç±¤ï¼‰
    function getStoryText() {
      return storyContentEl.innerText.trim();
    }
  
    // æ›´æ–°æŒ‰éˆ•æ–‡å­— / æ¨£å¼
    function updatePlayButton() {
      const textEl = playBtn.querySelector(".story-voice-text");
      if (isPlayingStory) {
        playBtn.classList.add("playing");
        textEl.textContent = "æ­£åœ¨èªªæ•…äº‹ä¸­ï¼ˆå†é»ä¸€ä¸‹å°±æœƒåœæ­¢ï¼‰";
      } else {
        playBtn.classList.remove("playing");
        textEl.textContent = "é»æˆ‘èªªæ•…äº‹";
      }
    }
  
    // ğŸ”Š é–‹å§‹èªªæ•…äº‹ï¼ˆå«ï¼šå…ˆæ’­ 3 ç§’ BGMï¼Œå†é€²å…¥èªéŸ³ + é™ BGM éŸ³é‡ï¼‰
    function startStory() {
      if (!("speechSynthesis" in window)) {
        alert("æ­¤ç€è¦½å™¨æš«ä¸æ”¯æ´èªéŸ³æœ—è®€åŠŸèƒ½ï¼Œå¯ä»¥æ”¹ç”¨éŒ„è£½å¥½çš„ MP3 è²éŸ³æª”å–”ï¼");
        return;
      }
  
      const text = getStoryText();
      if (!text) return;
  
      // ä¿éšªèµ·è¦‹ï¼Œå…ˆæ¸…æ‰ä»»ä½•èˆŠçš„èªéŸ³ / è¨ˆæ™‚å™¨ / æ·¡å‡º
      window.speechSynthesis.cancel();
      clearTimersAndFade();
  
      isPlayingStory = true;
      updatePlayButton();
  
      // 1ï¸âƒ£ å…ˆæ’­ BGMï¼ŒéŸ³é‡ 100%
      if (bgmAudio) {
        try {
          bgmAudio.currentTime = 0;
          bgmAudio.volume = 1.0; // å…¨éŸ³é‡
          bgmAudio.play().catch(() => {});
        } catch (e) {
          console.warn("BGM æ’­æ”¾å¤±æ•—ï¼š", e);
        }
      }
  
      // 2ï¸âƒ£ ç­‰ 3 ç§’å¾Œï¼Œé–‹å§‹å”¸æ•…äº‹ ï¼‹ æŠŠ BGM é™åˆ° 30%
      storyStartTimer = setTimeout(() => {
        startSpeechWithFade(text);
      }, 3000);
    }
  
    // ğŸ§  çœŸæ­£é–‹å§‹ TTS èªéŸ³ + BGM å¾ 1.0 æ·¡åˆ° 0.2
    function startSpeechWithFade(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "zh-TW";
      utter.rate = 1.0;
      utter.pitch = 1.0;
  
      utter.onend = () => {
  // æ•…äº‹è¬›å®Œå¾Œï¼šé€²å…¥ã€Œå°¾å¥æ¨¡å¼ã€
  console.log("æ•…äº‹æœ—è®€å®Œç•¢ï¼Œé€²å…¥ 5 ç§’å°¾å¥éŸ³æ¨‚");

  // å…ˆç¢ºä¿ BGM ç¹¼çºŒç”¨ 30% éŸ³é‡æ’­æ”¾ï¼ˆå¦‚æœè¢«æš«åœä¹Ÿé‡æ–°æ’­æ”¾ï¼‰
  if (bgmAudio) {
    try {
      bgmAudio.volume = 0.3;
      bgmAudio.play().catch(() => {});
    } catch (e) {}
  }

  // â–¶ é–‹å§‹ 5 ç§’å°¾å¥
  const endDelay = 5000; // 5 ç§’
  const endTimer = setTimeout(() => {
    console.log("å°¾å¥çµæŸï¼Œåœæ­¢èƒŒæ™¯éŸ³æ¨‚");

    // åœæ­¢ BGMï¼Œå›å¾©åˆå§‹ç‹€æ…‹
    if (bgmAudio) {
      try {
        bgmAudio.pause();
        bgmAudio.currentTime = 0;
        bgmAudio.volume = 1.0; // ä¸‹ä¸€æ¬¡å¾ 100% é–‹å§‹
      } catch (e) {}
    }

    isPlayingStory = false;
    updatePlayButton();
  }, endDelay);
};

  
      currentUtterance = utter;
      window.speechSynthesis.speak(utter);
  
      // ğŸš æŠŠ BGM éŸ³é‡å¾ 1.0 æ·¡åˆ° 0.3ï¼Œå¤§ç´„ 1 ç§’å…§å®Œæˆ
      if (bgmAudio) {
        const targetVolume = 0.2;
        const duration = 1000; // 1 ç§’
        const steps = 10;
        const stepTime = duration / steps;
        const startVolume = bgmAudio.volume || 1.0;
        const volumeDiff = startVolume - targetVolume;
        let currentStep = 0;
  
        clearInterval(bgmFadeInterval);
        bgmFadeInterval = setInterval(() => {
          currentStep++;
          const progress = currentStep / steps;
          const newVolume = startVolume - volumeDiff * progress;
          bgmAudio.volume = Math.max(targetVolume, Math.min(1.0, newVolume));
  
          if (currentStep >= steps) {
            bgmAudio.volume = targetVolume;
            clearInterval(bgmFadeInterval);
            bgmFadeInterval = null;
          }
        }, stepTime);
      }
    }
  
    // ğŸ›‘ åœæ­¢æ•…äº‹ + BGMï¼ˆä½¿ç”¨è€…æŒ‰ç¬¬äºŒæ¬¡æ™‚ï¼‰
    function stopStory() {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
      if (bgmAudio) {
        try {
          bgmAudio.pause();
          bgmAudio.currentTime = 0;
          bgmAudio.volume = 1.0; // å›å¾©åŸæœ¬éŸ³é‡
        } catch (e) {}
      }
      clearTimersAndFade();
      isPlayingStory = false;
      updatePlayButton();
    }
  
    // æ¸…æ‰è¨ˆæ™‚å™¨èˆ‡æ·¡å‡º interval
    function clearTimersAndFade() {
      if (storyStartTimer) {
        clearTimeout(storyStartTimer);
        storyStartTimer = null;
      }
      if (bgmFadeInterval) {
        clearInterval(bgmFadeInterval);
        bgmFadeInterval = null;
      }
    }
  
    // é»æ“Šå°æœå‰ï¼šæ’­æ”¾ / åœæ­¢ åˆ‡æ›
    playBtn.addEventListener("click", () => {
      if (isPlayingStory) {
        stopStory();
      } else {
        startStory();
      }
    });
  
    // è‹¥ä½¿ç”¨è€…é›¢é–‹é é¢ï¼Œå¹«å¿™æŠŠèªéŸ³èˆ‡ BGM é—œæ‰
    window.addEventListener("beforeunload", () => {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
      if (bgmAudio) {
        try {
          bgmAudio.pause();
        } catch (e) {}
      }
      clearTimersAndFade();
    });
  </script>  
</body>
</html>
